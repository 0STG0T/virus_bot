#!/usr/bin/env python3
"""
Virus Bot Manager - –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ñ—Ä–∏ —Å–ø–∏–Ω–æ–≤ –≤ @virus_play_bot

–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–∫—Ä—É—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö —Ñ—Ä–∏ —Å–ø–∏–Ω–æ–≤
- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏–π –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏–Ω–æ–≤ (—Ä–µ—Ñ–∫–∏, –ø–æ–¥–ø–∏—Å–∫–∏)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≥—Ä–∞–¥ –∏ –∞–≤—Ç–æ–ø—Ä–æ–¥–∞–∂–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 500+ –∞–∫–∫–∞—É–Ω—Ç–æ–≤

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python main.py
"""

import asyncio
import logging
import os
import sys
from telegram_bot import VirusBotManager

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.DEBUG,  # –í–∫–ª—é—á–∞–µ–º DEBUG –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('virus_bot.log', encoding='utf-8'),
        logging.StreamHandler(sys.stdout)
    ]
)

logger = logging.getLogger(__name__)

def print_banner():
    """–í—ã–≤–æ–¥–∏—Ç –∫—Ä–∞—Å–∏–≤—ã–π –±–∞–Ω–Ω–µ—Ä"""
    banner = """
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë                     VIRUS BOT MANAGER                         ‚ïë
    ‚ïë                –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è @virus_play_bot                   ‚ïë
    ‚ïë                                                                ‚ïë
    ‚ïë  ‚ö° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–∫—Ä—É—Ç —Ñ—Ä–∏ —Å–ø–∏–Ω–æ–≤                          ‚ïë
    ‚ïë  üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏–π (—Ä–µ—Ñ–∫–∏, –ø–æ–¥–ø–∏—Å–∫–∏)                      ‚ïë
    ‚ïë  üí∞ –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≥—Ä–∞–¥ –∏ –∞–≤—Ç–æ–ø—Ä–æ–¥–∞–∂–∞                            ‚ïë
    ‚ïë  ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞                            ‚ïë
    ‚ïë  üìä –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 500+ –∞–∫–∫–∞—É–Ω—Ç–æ–≤                                  ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    """
    print(banner)

def check_requirements():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫"""
    sessions_dir = "./sessions"

    if not os.path.exists(sessions_dir):
        print(f"üìÅ –°–æ–∑–¥–∞—é –ø–∞–ø–∫—É {sessions_dir}")
        os.makedirs(sessions_dir)

    session_files = [f for f in os.listdir(sessions_dir) if f.endswith('.session')]
    print(f"üìä –ù–∞–π–¥–µ–Ω–æ {len(session_files)} —Å–µ—Å—Å–∏–π –≤ –ø–∞–ø–∫–µ {sessions_dir}")

    if len(session_files) == 0:
        print("‚ö†Ô∏è  –°–µ—Å—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ .session —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫—É sessions/")
        print("üìã –§–æ—Ä–º–∞—Ç: –∏–º—è_–∞–∫–∫–∞—É–Ω—Ç–∞.session")

    return len(session_files) > 0

async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    print_banner()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
    if not check_requirements():
        print("‚ùå –î–ª—è —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã —Å–µ—Å—Å–∏–∏ –≤ –ø–∞–ø–∫–µ sessions/")
        # –í Docker –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º input (–Ω–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞)
        if os.getenv('DOCKER_CONTAINER'):
            return
        input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")
        return

    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º
    bot_token = os.getenv('VIRUS_BOT_TOKEN', '').strip()

    if not bot_token:
        # –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ
        print("\nüîë –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:")
        print("   (–ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É @BotFather)")
        print("   (–∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è VIRUS_BOT_TOKEN)")

        try:
            bot_token = input("ü§ñ –¢–æ–∫–µ–Ω –±–æ—Ç–∞: ").strip()
        except EOFError:
            print("\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω (–Ω–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞)")
            print("üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è VIRUS_BOT_TOKEN")
            print("   –ü—Ä–∏–º–µ—Ä: export VIRUS_BOT_TOKEN='your_token_here'")
            return

    if not bot_token:
        print("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
        if not os.getenv('DOCKER_CONTAINER'):
            input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")
        return

    if not bot_token.count(':') == 1 or len(bot_token) < 40:
        print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞")
        print(f"   –ü–æ–ª—É—á–µ–Ω —Ç–æ–∫–µ–Ω –¥–ª–∏–Ω–æ–π {len(bot_token)} —Å–∏–º–≤–æ–ª–æ–≤")
        if not os.getenv('DOCKER_CONTAINER'):
            input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")
        return

    print(f"‚úÖ –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ (–¥–ª–∏–Ω–∞: {len(bot_token)} —Å–∏–º–≤–æ–ª–æ–≤)")

    # –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    bot_manager = VirusBotManager()

    try:
        print("\nüîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞...")
        await bot_manager.setup(bot_token)

        print("‚úÖ –ë–æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
        print("üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
        print("üì± –ù–∞–π–¥–∏—Ç–µ —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram –∏ –Ω–∞–∂–º–∏—Ç–µ /start")
        print("üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C")

        await bot_manager.run()

    except KeyboardInterrupt:
        print("\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏...")
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}", exc_info=True)
    finally:
        print("üîÑ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...")
        await bot_manager.stop()
        print("‚úÖ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        print("üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\nüëã –†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: {e}")
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: {e}", exc_info=True)
        # –í Docker –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º input
        if not os.getenv('DOCKER_CONTAINER'):
            try:
                input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")
            except EOFError:
                pass